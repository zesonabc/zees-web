<?php
session_start();

// ================= 配置区 =================
// 1. 这里是你要的固定账号密码
$ADMIN_USER = 'zs10272891';
$ADMIN_PASS = 'Zhangsheng520';

// 2. 数据文件路径
$DATA_FILE = 'data.json';

// ================= Token 处理逻辑 =================
// 注意：由于我不知道你的Token，第一次使用时，请手动把你的Token填在下面 $initial_token 引号里
// 只要运行一次，它就会被保存起来。
$initial_token = ""; // <--- 在这里填入你的 Github/Cloudflare Token

// Token 存储文件 (为了不让你每次都改代码，我们把它存在一个隐藏文件里)
$token_file = '.token_secret'; 

// 如果有初始Token且文件不存在，先存进去
if (!empty($initial_token) && !file_exists($token_file)) {
    file_put_contents($token_file, $initial_token);
}

// 读取当前使用的 Token
$CURRENT_TOKEN = file_exists($token_file) ? file_get_contents($token_file) : $initial_token;
// ============================================

// 登录逻辑
if (isset($_POST['login'])) {
    if ($_POST['username'] === $ADMIN_USER && $_POST['password'] === $ADMIN_PASS) {
        $_SESSION['user'] = $ADMIN_USER;
        header('Location: admin.php');
        exit;
    } else {
        $error = "账号或密码错误！";
    }
}

// 登出
if (isset($_GET['logout'])) {
    session_destroy();
    header('Location: admin.php');
    exit;
}

// 拦截未登录
if (!isset($_SESSION['user'])) {
?>
<!DOCTYPE html>
<html>
<head>
    <title>苹巨匠后台登录</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen">
    <div class="bg-slate-800 p-8 rounded-xl shadow-2xl w-full max-w-md border border-slate-700">
        <h2 class="text-2xl font-bold text-white mb-6 text-center">苹巨匠控制台</h2>
        <?php if(isset($error)) echo "<p class='text-red-500 mb-4 text-center bg-red-500/10 p-2 rounded'>$error</p>"; ?>
        <form method="post" class="space-y-4">
            <div>
                <label class="block text-slate-400 text-sm mb-1">账号</label>
                <input type="text" name="username" class="w-full bg-slate-700 text-white rounded p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-slate-400 text-sm mb-1">密码</label>
                <input type="password" name="password" class="w-full bg-slate-700 text-white rounded p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button type="submit" name="login" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded transition">登 录</button>
        </form>
    </div>
</body>
</html>
<?php
    exit;
}

// ================= 已登录区域 =================

// 处理数据保存
$message = '';
if (isset($_POST['save_data'])) {
    $json_data = $_POST['json_data'];
    // 简单的 JSON 验证
    if (json_decode($json_data) != null) {
        file_put_contents($DATA_FILE, $json_data);
        
        // 如果用户在后台更新了 Token，也顺便存一下
        if (!empty($_POST['auth_token'])) {
            file_put_contents($token_file, $_POST['auth_token']);
            $CURRENT_TOKEN = $_POST['auth_token'];
        }

        $message = "保存成功！页面已更新。";
    } else {
        $message = "JSON 格式错误，保存失败！";
    }
}

// 读取当前 JSON
$current_data = file_exists($DATA_FILE) ? file_get_contents($DATA_FILE) : '[]';
?>

<!DOCTYPE html>
<html>
<head>
    <title>数据管理 - 苹巨匠</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-slate-200 min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-white">后台数据管理</h1>
            <a href="?logout" class="text-red-400 hover:text-red-300 text-sm">退出登录</a>
        </div>

        <?php if($message): ?>
            <div class="bg-blue-900/50 border border-blue-500/50 text-blue-200 p-4 rounded mb-6">
                <?php echo $message; ?>
            </div>
        <?php endif; ?>

        <form method="post" class="space-y-6">
            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <label class="block text-white font-bold mb-2">JSON 数据内容</label>
                <p class="text-xs text-slate-400 mb-2">格式: [{"title":"标题", "bvid":"视频号", "link":"网盘链接", "desc":"描述"}]</p>
                <textarea name="json_data" rows="15" class="w-full bg-slate-900 text-green-400 font-mono text-sm p-4 rounded-lg border border-slate-700 focus:outline-none focus:border-blue-500"><?php echo htmlspecialchars($current_data); ?></textarea>
            </div>

            <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <label class="block text-white font-bold mb-2">API Token (可选更新)</label>
                <input type="text" name="auth_token" value="<?php echo htmlspecialchars($CURRENT_TOKEN); ?>" class="w-full bg-slate-900 text-slate-300 p-2 rounded border border-slate-700" placeholder="在此处输入新的 Token 可覆盖旧的">
            </div>

            <div class="flex gap-4">
                <button type="submit" name="save_data" class="flex-1 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg transition">保存更改</button>
                <a href="index.html" target="_blank" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white text-center font-bold py-3 rounded-lg transition">查看主页</a>
            </div>
        </form>
    </div>
</body>
</html>
